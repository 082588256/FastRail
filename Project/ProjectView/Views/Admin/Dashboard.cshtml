@model ProjectView.Models.Admin.Dashboard.AdminDashBoardViewModel;
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
<style>
    .chart-container {
        position: relative;
        height: 180px;
        padding-bottom:inherit;
    }
</style>
<!-- Overview Cards -->
<div class="row">
    <div class="col-md-12">
        <div class="overview-wrap">
            <h2 class="title-1">overview</h2>
            <button class="au-btn au-btn-icon au-btn--blue">
                <i class="zmdi zmdi-plus"></i>add item
            </button>
        </div>
    </div>
</div>

<div class="row m-t-25">
    <!-- Card 1 -->
    <div class="col-sm-6 col-lg-3">
        <div class="overview-item overview-item--c1">
            <div class="overview__inner">
                <div class="overview-box clearfix">
                    <div class="icon"><i class="zmdi zmdi-account-o"></i></div>
                    <div class="text"><h2>@Model.ActiveRoutes</h2><span>Tuyến Đang Hoạt Động</span></div>
                </div>
                <div class="overview-chart"><canvas id="widgetChart1"></canvas></div>
            </div>
        </div>
    </div>
    <!-- Card 2 -->
    <div class="col-sm-6 col-lg-3">
        <div class="overview-item overview-item--c2">
            <div class="overview__inner">
                <div class="overview-box clearfix">
                    <div class="icon"><i class="zmdi zmdi-shopping-cart"></i></div>
                    <div class="text"><h2>@Model.TicketsToday</h2><span>Vé Bán Hôm Nay</span></div>
                </div>
                <div class="overview-chart"><canvas id="widgetChart2"></canvas></div>
            </div>
        </div>
    </div>
    <!-- Card 3 -->
    <div class="col-sm-6 col-lg-3">
        <div class="overview-item overview-item--c3">
            <div class="overview__inner">
                <div class="overview-box clearfix">
                    <div class="icon"><i class="zmdi zmdi-calendar-note"></i></div>
                    <div class="text"><h2>@Model.SeatOccupancyRate %</h2><span>Tỉ lệ ghế trống</span></div>
                </div>
                <div class="overview-chart"><canvas id="widgetChart3"></canvas></div>
            </div>
        </div>
    </div>
    <!-- Card 4 -->
    <div class="col-sm-6 col-lg-3">
        <div class="overview-item overview-item--c4">
            <div class="overview__inner">
                <div class="overview-box clearfix">
                    <div class="icon"><i class="zmdi zmdi-money"></i></div>
                    <div class="text"><h2>@Model.TodayRevenue</h2><span>Doanh Thu Hôm Nay</span></div>
                </div>
                <div class="overview-chart"><canvas id="widgetChart4"></canvas></div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row">
    <div class="col-lg-6">
        <div class="au-card recent-report">
            <div class="au-card-inner">
                <h3 class="title-3">Trips Report</h3>
                <div class="recent-report__chart"><canvas id="recent-trip-chart"></canvas></div>
                <p id="tripChartError" class="text-danger mt-2"></p>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="au-card chart-percent-card">
            <div class="au-card-inner">
                <h3 class="title-3">Seats Percentage Report</h3>
                <div class="row no-gutters">
                    <select id="trip-select" class="form-control mb-3"></select>
                    <div class="col-xl-12">
                        <div class="chart-container">
                            <div class="percent-chart text-center mt-n2">
                                <canvas id="percent-chart-seat"></canvas>
                            </div>
                        </div>
                        
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    
</div>
<div class="row">
    <div class="col-xl-12 col-md-12">
        <div class="au-card">
            <div class="au-card-inner">
                <canvas id="trips-standings"></canvas>
            </div>
            <span id="chart-trip-error" class="mb-2 text-danger"></span>
        </div>
    </div>
</div>


<!-- Footer -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch("/Admin/getTripData")
            .then(response => response.json())
            .then(data => {
                const labelsS = data.dates;
                const counts = data.counts;
                new Chart(document.getElementById("recent-trip-chart"), {
                    type: 'bar',
                    data: {
                        labels: labelsS,
                        datasets: [{
                            label: "Số lượng chuyến theo ngày",
                            data: counts.map(x => Number(x)),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            })
            .catch((error) => {
                document.getElementById("tripChartError").innerHTML = "<p class='text-muted'>Không có dữ liệu để hiển thị.</p>";
            });
    });


</script>

<script>
    let chart; 
    let data = [];

    document.addEventListener("DOMContentLoaded", function () {
        fetch("/Admin/getSeatData")
            .then(res => res.json())
            .then(json => {
                data = json;

                const select = document.getElementById("trip-select");
                data.forEach((trip, index) => {
                    const option = document.createElement("option");
                    option.value = index;
                    option.textContent = trip.tripName;
                    select.appendChild(option);
                });
                loadChart(0);
                select.addEventListener("change", function () {
                    const index = parseInt(this.value);
                    loadChart(index);
                });
            });
    });

    function loadChart(index) {
        const trip = data[index];
        const ctx = document.getElementById("percent-chart-seat").getContext("2d");

        const chartData = {
            labels: ['Đã bán', 'Còn trống'],
            datasets: [{
                data: [trip.soldSeats, trip.emptySeats],
                backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)']
            }]
        };

        const chartOptions = {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: trip.tripName
                }
            }
        };
        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: chartOptions
        });
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch("@Url.Action("getTopTrips", "Admin")")
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (!Array.isArray(data) || data.length === 0) {
                    document.getElementById("chart-trip-error").innerHTML = "<p class='text-muted'>Không có dữ liệu để hiển thị.</p>";
                    return;
                }

                const tripNames = data.map(t => t.tripName);
                const revenues = data.map(t => t.revenue);

                const ctx = document.getElementById("trips-standings").getContext("2d");

                if (window.TripCharts) {
                    window.TripCharts.destroy();
                }

                window.TripCharts = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: tripNames,
                        datasets: [{
                            label: "Top chuyến có doanh thu cao (VND)",
                            data: revenues,
                            backgroundColor: '#4e73df'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: ctx => ctx.raw.toLocaleString() + ' đ'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => value.toLocaleString() + ' đ'
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.log(error);
                document.getElementById("chart-trip-error").innerHTML = "<p class='text-muted'>Không có dữ liệu để hiển thị.</p>";
            });
    });
</script>
